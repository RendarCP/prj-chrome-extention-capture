chrome.runtime.onMessage.addListener((r,m,o)=>{const l=new Map;let a=null;if(r.action==="captureFullPage"){const e=Math.max(document.documentElement.scrollHeight,document.body.scrollHeight);o({success:!0,fullHeight:e})}else if(r.action==="prepareCapture")try{const e=window.pageYOffset||document.documentElement.scrollTop,t=window.getComputedStyle(document.body);a={position:t.position||"static",minWidth:t.minWidth,minHeight:t.minHeight,display:t.display,top:t.top,left:t.left,right:t.right,bottom:t.bottom,width:t.width,height:t.height,margin:t.margin,transform:t.transform,zIndex:t.zIndex},document.body.style.cssText+=`
        position: relative !important;
        min-width: 100vw !important;
        min-height: 100vh !important;
      `;const n=Array.from(document.querySelectorAll("*")).filter(i=>getComputedStyle(i).position==="sticky"),c=document.querySelectorAll('header, nav, .fixed, [style*="position: fixed"], [style*="position:fixed"]');n.forEach(i=>{const s=window.getComputedStyle(i);l.set(i,{position:s.position,inset:s.inset}),i.style.cssText=`
            position: relative !important;
            inset: auto !important;
          `}),setTimeout(()=>{l.forEach((i,s)=>{s.style.position=i.position||"",s.style.inset=i.inset||""}),l.clear()},5e3),document.documentElement.style.setProperty("scroll-behavior","auto","important"),document.body.style.setProperty("overflow","visible","important"),document.documentElement.style.setProperty("overflow","visible","important"),o({success:!0})}catch(e){console.error("Error in prepareCapture:",e),o({success:!1,error:e instanceof Error?e.message:"Unknown error"})}else if(r.action==="scrollTo"&&typeof r.position=="number")try{window.scrollTo({top:r.position,behavior:"instant"}),o({success:!0})}catch(e){console.error("Error in scrollTo:",e),o({success:!1,error:e instanceof Error?e.message:"Unknown error"})}else if(r.action==="restoreStyles")try{l.forEach((e,t)=>{t.style.cssText="",Object.entries(e).forEach(([n,c])=>{c&&c!=="auto"&&t.style.setProperty(n,c,"")})}),l.clear(),a&&(document.body.style.position=a.position,document.body.style.minWidth=a.minWidth||"",document.body.style.minHeight=a.minHeight||""),document.documentElement.style.removeProperty("scroll-behavior"),document.body.style.removeProperty("overflow"),document.documentElement.style.removeProperty("overflow"),o({success:!0})}catch(e){console.error("Error in restoreStyles:",e),o({success:!1,error:e instanceof Error?e.message:"Unknown error"})}else if(r.action==="getScrollPosition"){const e=window.pageYOffset||document.documentElement.scrollTop;o({success:!0,scrollPosition:e})}else{if(r.action==="checkPageLoad")return new Promise(t=>{if(document.readyState==="complete"){const n=document.getElementsByTagName("img"),c=Array.from(n).map(i=>new Promise(s=>{i.complete?s(!0):(i.onload=()=>s(!0),i.onerror=()=>s(!0))}));Promise.all(c).then(()=>{t(!0)})}else window.addEventListener("load",()=>{t(!0)})}).then(()=>{o({success:!0,loaded:!0})}),!0;if(r.action==="hideNavigation")document.querySelectorAll("nav, header").forEach(t=>{t.style.display="none"}),o({success:!0});else if(r.action==="showNavigation")document.querySelectorAll("nav, header").forEach(t=>{t.style.display=""}),o({success:!0});else if(r.action==="hideFixedElements")try{Array.from(document.querySelectorAll("*")).filter(t=>getComputedStyle(t).position==="fixed").forEach(t=>{const n=t,c=window.getComputedStyle(n);l.set(n,{visibility:c.visibility,overflow:c.overflow}),n.style.cssText=`
            visibility: hidden !important;
            overflow: hidden !important;
          `}),o({success:!0})}catch(e){console.error("Error in hideFixedElements:",e),o({success:!1,error:e instanceof Error?e.message:"Unknown error"})}else if(r.action==="showFixedElements")try{l.forEach((e,t)=>{t.style.visibility=e.visibility||"",t.style.overflow=e.overflow||""}),l.clear(),o({success:!0})}catch(e){console.error("Error in showFixedElements:",e),o({success:!1,error:e instanceof Error?e.message:"Unknown error"})}}return!0});
